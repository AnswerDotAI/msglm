# core


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
from IPython.display import Image, display
from pathlib import Path
```

``` python
from pathlib import Path
```

## API Exploration

Anthropicâ€™s Claude and OpenAIâ€™s GPT models are some of the most popular
LLMs.

Letâ€™s take a look at their APIs and to learn how we should structure our
messages for a simple text chat.

#### openai

``` python
from openai import OpenAI
```

``` python
client = OpenAI()

client.responses.create(
  model="gpt-4.1",
  input=[ {"role": "user", "content": "Hello, world!"} ]
)
```

Hello, world! ðŸ‘‹ How can I help you today?

<details>

- id: resp_68a4d422397c81a19fb6b4d899b25e7b029dfdae1caafc84
- created_at: 1755632674.0
- error: None
- incomplete_details: None
- instructions: None
- metadata: {}
- model: gpt-4.1-2025-04-14
- object: response
- output:
  \[ResponseOutputMessage(id=â€˜msg_68a4d42338fc81a1ac7fba8e496af1a1029dfdae1caafc84â€™,
  content=\[ResponseOutputText(annotations=\[\], text=â€˜Hello, world! ðŸ‘‹
  How can I help you today?â€™, type=â€˜output_textâ€™, logprobs=\[\])\],
  role=â€˜assistantâ€™, status=â€˜completedâ€™, type=â€˜messageâ€™)\]
- parallel_tool_calls: True
- temperature: 1.0
- tool_choice: auto
- tools: \[\]
- top_p: 1.0
- background: False
- max_output_tokens: None
- max_tool_calls: None
- previous_response_id: None
- prompt: None
- prompt_cache_key: None
- reasoning: Reasoning(effort=None, generate_summary=None, summary=None)
- safety_identifier: None
- service_tier: default
- status: completed
- text: ResponseTextConfig(format=ResponseFormatText(type=â€˜textâ€™),
  verbosity=â€˜mediumâ€™)
- top_logprobs: 0
- truncation: disabled
- usage: ResponseUsage(input_tokens=11,
  input_tokens_details=InputTokensDetails(cached_tokens=0),
  output_tokens=14,
  output_tokens_details=OutputTokensDetails(reasoning_tokens=0),
  total_tokens=25)
- user: None
- store: True

</details>

#### anthropic

``` python
from anthropic import Anthropic
```

``` python
client = Anthropic()

client.messages.create(
    model="claude-3-haiku-20240307",
    max_tokens=1024,
    messages=[ {"role": "user", "content": "Hello, world!"} ]
)
```

Hello! Itâ€™s great to meet you. Iâ€™m an AI assistant created by Anthropic.
Iâ€™m here to help with a wide variety of tasks, from analysis and
research to creative projects and casual conversation. Please let me
know if thereâ€™s anything I can assist you with.

<details>

- id: `msg_01LVFGsTHhwM65ESmydXgm3o`
- content:
  `[{'citations': None, 'text': "Hello! It's great to meet you. I'm an AI assistant created by Anthropic. I'm here to help with a wide variety of tasks, from analysis and research to creative projects and casual conversation. Please let me know if there's anything I can assist you with.", 'type': 'text'}]`
- model: `claude-3-haiku-20240307`
- role: `assistant`
- stop_reason: `end_turn`
- stop_sequence: `None`
- type: `message`
- usage:
  `{'cache_creation': {'ephemeral_1h_input_tokens': 0, 'ephemeral_5m_input_tokens': 0}, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'input_tokens': 11, 'output_tokens': 60, 'server_tool_use': None, 'service_tier': 'standard'}`

</details>

As we can see both APIs use the exact same message structure.

### mk_msg

Ok, letâ€™s build the first version of
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) to
handle this case

``` python
def mk_msg(content:str, role:str="user")->dict:
    "Create an OpenAI/Anthropic compatible message."
    return dict(role=role, content=content)
```

Letâ€™s test it out with the OpenAI API. To do that weâ€™ll need to setup
two things:

- install the openai SDK by running `pip install openai`
- add your openai api key to your env vars
  `export OPENAI_API_KEY="YOUR_OPEN_API_KEY"`

``` python
oa_cli = OpenAI()

r = oa_cli.responses.create(
  model="gpt-4o-mini",
  input=[mk_msg("Hello, world!")]
)
r.output_text
```

    'Hello! How can I assist you today?'

Now, letâ€™s test out
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) on the
Anthropic API. To do that weâ€™ll need to setup two things:

- install the openai SDK by running `pip install anthropic`
- add your anthropic api key to your env vars
  `export ANTHROPIC_API_KEY="YOUR_ANTHROPIC_API_KEY"`

``` python
a_cli = Anthropic()

r = a_cli.messages.create(
    model="claude-3-haiku-20240307",
    max_tokens=1024,
    messages=[mk_msg("Hello, world!")]
)
r.content[0].text
```

    "Hello! I'm an AI assistant created by Anthropic. It's nice to meet you. How can I help you today?"

So far so good!

#### Helper Functions

Before going any further, letâ€™s create some helper functions to make it
a little easier to call the OpenAI and Anthropic APIs. Weâ€™re going to be
making a bunch of API calls to test our code and typing the full
expressions out each time will become a little tedious. These functions
wonâ€™t be included in the final package.

``` python
def openai_chat(msgs: list)->tuple:
    "call the openai chat responses endpoint with `msgs`."
    r = oa_cli.responses.create(model="o4-mini", input=msgs)
    return r, r.output_text
```

Letâ€™s double check that
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) still
works with our simple text example from before.

``` python
_, text = openai_chat([mk_msg("Hello, world!")])
text
```

    'Hello there! How can I assist you today?'

``` python
def anthropic_chat(msgs: list)->tuple:
    "call the anthropic messages endpoint with `msgs`."
    r = a_cli.messages.create(model="claude-sonnet-4-20250514", max_tokens=1024, messages=msgs)
    return r, r.content[0].text
```

and Anthropicâ€¦

``` python
_, text = anthropic_chat([mk_msg("Hello, world!")])
text
```

    'Hello! Nice to meet you. How are you doing today? Is there anything I can help you with?'

### Images

Ok, letâ€™s see how both APIs handle image messages.

<img src="https://claudette.answer.ai/index_files/figure-html/cell-35-output-1.jpeg" height=240 width=240></img>

#### openai

``` python
import base64, httpx
```

``` python
img_url = "https://claudette.answer.ai/index_files/figure-html/cell-35-output-1.jpeg"
```

``` python
mtype = "image/jpeg"
img_content = httpx.get(img_url).content
```

``` python
img = base64.b64encode(img_content).decode("utf-8")

client = OpenAI()
r = client.responses.create(
    model="gpt-4o-mini",
    input=[
        {
            "role":"user",
            "content": [
                {"type":"input_text","text":"What's in this image?"},
                {"type":"input_image","image_url":f"data:image/jpeg;base64,{img}"},
            ],
        }
    ],
)
r.output_text
```

    'The image features a puppy lying on the grass near a cluster of purple flowers. The puppy has a brown and white coat, with large, expressive eyes and floppy ears, giving it an adorable appearance.'

#### anthropic

``` python
mtype = "image/jpeg"
img = base64.b64encode(img_content).decode("utf-8")

client = Anthropic()
r = client.messages.create(
    model="claude-3-haiku-20240307",
    max_tokens=1024,
    messages=[
        {
            "role":"user",
            "content": [
                {"type":"text","text":"What's in this image?"},
                {"type":"image","source":{"type":"base64","media_type":mtype,"data":img}}
            ],
        }
    ],
)
r.content[0].text
```

    'The image shows a close-up of a cute puppy lying in the grass. The puppy appears to be a Cavalier King Charles Spaniel, with a fluffy brown and white coat. The puppy is looking directly at the camera with a friendly, curious expression. In the background, there are some purple daisy-like flowers blooming, adding a nice natural setting to the scene.'

Both APIs format images slightly differently and the structure of the
message `content` is a little more complex.

In a text chat, `content` is a simple string but for a multimodal chat
(text+images) we can see that `content` is a list of dictionaries.

## Msg Class

### Basics

Letâ€™s create
[`_mk_img`](https://AnswerDotAI.github.io/msglm/core.html#_mk_img) to
make our code a little DRYâ€™r.

<details open class="code-fold">
<summary>Exported source</summary>

``` python
def _mk_img(data:bytes)->tuple:
    "Convert image bytes to a base64 encoded image"
    img = base64.b64encode(data).decode("utf-8")
    mtype = mimetypes.types_map["."+imghdr.what(None, h=data)]
    return img, mtype
```

</details>

To handle the additional complexity of multimodal messages letâ€™s build a
[`Msg`](https://AnswerDotAI.github.io/msglm/core.html#msg) class for the
`content` data structure:

``` json
{
    "role": "user",
    "content": [{"type": "text", "text": "What's in this image?"}],
}
```

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L26"
target="_blank" style="float:right; font-size:smaller">source</a>

### Msg

``` python

def Msg(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Helper class to create a message for the OpenAI and Anthropic APIs.*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
class Msg:
    "Helper class to create a message for the OpenAI and Anthropic APIs."
    pass
```

</details>

As both APIs handle images differently letâ€™s subclass
[`Msg`](https://AnswerDotAI.github.io/msglm/core.html#msg) for each API
and handle the image formatting in a method called `img_msg`.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L31"
target="_blank" style="float:right; font-size:smaller">source</a>

### OpenAiMsg

``` python

def OpenAiMsg(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Helper class to create a message for the OpenAI API.*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
class OpenAiMsg(Msg):
    "Helper class to create a message for the OpenAI API."
    pass
```

</details>

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L36"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg

``` python

def AnthropicMsg(
    args:VAR_POSITIONAL, kwargs:VAR_KEYWORD
):

```

*Helper class to create a message for the Anthropic API.*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
class AnthropicMsg(Msg):
    "Helper class to create a message for the Anthropic API."
    pass
```

</details>

Letâ€™s write some helper functions for `mk_content` to use.

<details open class="code-fold">
<summary>Exported source</summary>

``` python
def _is_img(data): return isinstance(data, bytes) and bool(imghdr.what(None, data))
```

</details>

A PDF [file](https://docs.fileformat.com/pdf/#pdf-file-header) should
start with `%PDF` followed by the pdf version `%PDF-1.1`

<details open class="code-fold">
<summary>Exported source</summary>

``` python
def _is_pdf(data): 
    is_byte_pdf = isinstance(data, bytes) and data.startswith(b'%PDF-')
    is_pdf_url = isinstance(data, str) and (
        data.startswith("http") and (data.endswith(".pdf") or 'pdf' in data.split('/'))
    )
    return is_byte_pdf or is_pdf_url
```

</details>

``` python
assert _is_pdf("https://arxiv.org/pdf/2301.00001")
assert not _is_pdf("https://arxiv.org/abs/2301.00001")
assert _is_pdf("https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf")
assert not _is_pdf("Hi /pdf/")
```

We create an appropriate type based on content:

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L53"
target="_blank" style="float:right; font-size:smaller">source</a>

### Msg.mk_content

``` python

def mk_content(
    content, text_only:bool=False
)->dict:

```

<details open class="code-fold">
<summary>Exported source</summary>

``` python
@patch
def mk_content(self:Msg, content, text_only=False)->dict:
    if _is_img(content): return self.img_msg(content)
    if _is_pdf(content): return self.pdf_msg(content)
    if isinstance(content, str): return self.text_msg(content, text_only=text_only)
    return content
```

</details>

â€¦then we call the model with this content:

``` python
@patch
def __call__(self:Msg, role:str, content:[list, str], text_only:bool=False, **kw)->dict:
    "Create an OpenAI/Anthropic compatible message with `role` and `content`."
    if content is not None and not isinstance(content, list): content = [content]
    content = [self.mk_content(o, text_only=text_only) for o in content] if content else ''
    return dict(role=role, content=content[0] if text_only else content, **kw)
```

OpenAI implementations:

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L67"
target="_blank" style="float:right; font-size:smaller">source</a>

### OpenAiMsg.text_msg

``` python

def text_msg(
    s:str, text_only:bool=False
)->dict:

```

*Convert `s` to a text message*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
@patch
def img_msg(self:OpenAiMsg, data:bytes)->dict:
    "Convert `data` to an image message"
    img, mtype = _mk_img(data)
    return {"type": "input_image", "image_url": f"data:{mtype};base64,{img}"}

@patch
def text_msg(self:OpenAiMsg, s:str, text_only=False)->dict: 
    "Convert `s` to a text message"
    if not s.strip(): s='.'
    return s if text_only else {"type": "input_text", "text":s}
```

</details>

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L61"
target="_blank" style="float:right; font-size:smaller">source</a>

### OpenAiMsg.img_msg

``` python

def img_msg(
    data:bytes
)->dict:

```

*Convert `data` to an image message*

Anthropic implementations:

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L81"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg.text_msg

``` python

def text_msg(
    s:str, text_only:bool=False
)->dict:

```

*Convert `s` to a text message*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
@patch
def img_msg(self:AnthropicMsg, data:bytes)->dict:
    "Convert `data` to an image message"
    img, mtype = _mk_img(data)
    r = {"type": "base64", "media_type": mtype, "data":img}
    return {"type": "image", "source": r}

@patch
def text_msg(self:AnthropicMsg, s:str, text_only=False)->dict: 
    "Convert `s` to a text message"
    if not s.strip(): s='.'
    return s if text_only else {"type": "text", "text":s}
```

</details>

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L74"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg.img_msg

``` python

def img_msg(
    data:bytes
)->dict:

```

*Convert `data` to an image message*

Update [`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg)
to use [`Msg`](https://AnswerDotAI.github.io/msglm/core.html#msg).

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L87"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_msg

``` python

def mk_msg(
    content:Union, role:str='user', args:VAR_POSITIONAL, api:str='openai', kw:VAR_KEYWORD
)->dict:

```

*Create an OpenAI/Anthropic compatible message.*

``` python
mk_msg(["Hello world", "how are you?"], api='openai')
```

``` json
{ 'content': [ {'text': 'Hello world', 'type': 'input_text'},
               {'text': 'how are you?', 'type': 'input_text'}],
  'role': 'user'}
```

``` python
mk_msg(["Hello world", "how are you?"], api='anthropic')
```

``` json
{ 'content': [ {'text': 'Hello world', 'type': 'text'},
               {'text': 'how are you?', 'type': 'text'}],
  'role': 'user'}
```

``` python
msg = mk_msg([img_content, "describe this picture"], api="openai")
_, text = openai_chat([msg])
text
```

    'This is an outdoor scene featuring a young puppy resting in a garden setting. Key details include:\n\nâ€¢ Breed characteristics: The puppy has the look of a Cavalier King Charles Spaniel  \nâ€¢ Coloring: Predominantly white coat with rich chestnut-brown patches on the ears, around the eyes, and a spot on the body  \nâ€¢ Facial features: Large, dark brown eyes; a small black nose; gentle, curious expression  \nâ€¢ Pose: Lying down on green grass, front legs stretched forward, head lowered slightly as if peeking out  \nâ€¢ Surroundings:  \n  â€“ A cluster of small, purple daisy-like flowers (possibly asters) to one side  \n  â€“ A wooden structure or planter partially visible behind the puppy, providing shade and a cozy nook  \nâ€¢ Lighting and mood: Soft, natural daylight with a calm, tranquil atmosphereâ€”conveys a sense of innocence and playfulness  \n\nOverall, the image captures an adorable moment of a floppy-eared puppy relaxing amid a patch of grass and blooms.'

``` python
msg = mk_msg([img_content, "describe this picture"], api="anthropic")
_, text = anthropic_chat([msg])
text
```

    'This is an adorable photograph of a young puppy, likely a Cavalier King Charles Spaniel, lying on grass. The puppy has beautiful reddish-brown and white markings - with white on the face, chest, and paws, and rich brown coloring around the ears and eyes. The puppy has sweet, dark eyes and long, silky ears typical of the breed.\n\nThe setting appears to be a garden, with purple flowers (possibly asters or similar blooms) visible in the background, creating a lovely natural backdrop. The puppy is positioned on green grass, and there seems to be a brick or stone structure behind the flowers. The lighting is soft and natural, giving the image a warm, peaceful quality that perfectly captures the innocence and charm of this young dog.'

### PDFs

What about chatting with PDFs? Unfortunately, OpenAIâ€™s message
completions API doesnâ€™t offer PDF support at the moment, but Claude
[does](https://docs.anthropic.com/en/docs/build-with-claude/pdf-support).

Under the hood, Claude extracts the text from the PDF and converts each
page to an image. This means you can ask Claude about any text,
pictures, charts, and tables in the PDF. Hereâ€™s an example from the
Claude
[docs](https://docs.anthropic.com/en/docs/build-with-claude/pdf-support#how-to-use-pdfs-in-the-messages-api).
Overall the message structure is pretty similar to an image message.

``` python
pdf_url = "https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf"
pdf_data = base64.standard_b64encode(httpx.get(pdf_url).content).decode("utf-8")
client = anthropic.Anthropic()
message = client.messages.create(
    model="claude-3-5-sonnet-20241022", max_tokens=1024,
    messages=[{
        "role": "user",
        "content": [
            {
                "type": "document",
                "source": { "type": "base64", "media_type": "application/pdf", "data": pdf_data }
            },
            {
                "type": "text",
                "text": "Which model has the highest human preference win rates across each use-case?"
            }
        ]
    }]
)
```

The Anthropic API has since offered an option for PDFs that can be
accessed online via url.

``` python
client = anthropic.Anthropic()
message = client.messages.create(
    model="claude-opus-4-20250514",
    max_tokens=1024,
    messages=[
        {
            "role": "user",
            "content": [
                {
                    "type": "document",
                    "source": {
                        "type": "url",
                        "url": "https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf"
                    }
                },
                {
                    "type": "text",
                    "text": "What are the key findings in this document?"
                }
            ]
        }
    ],
)
```

Letâ€™s create a method that converts a byte string to the base64 encoded
string that Anthropic expects.

<details open class="code-fold">
<summary>Exported source</summary>

``` python
def _mk_pdf(data:bytes)->str:
    "Convert pdf bytes to a base64 encoded pdf"
    return base64.standard_b64encode(data).decode("utf-8")
```

</details>

We add a `pdf_msg` method to
[`AnthropicMsg`](https://AnswerDotAI.github.io/msglm/core.html#anthropicmsg)
that uses
[`_mk_pdf`](https://AnswerDotAI.github.io/msglm/core.html#_mk_pdf).

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L101"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg.pdf_msg

``` python

def pdf_msg(
    data:bytes | str
)->dict:

```

*Convert `data` to a pdf message*

<details open class="code-fold">
<summary>Exported source</summary>

``` python
@patch
def pdf_msg(self:AnthropicMsg, data: bytes | str) -> dict:
    "Convert `data` to a pdf message"
    if isinstance(data, bytes):
        r = {"type": "base64", "media_type": "application/pdf", "data":_mk_pdf(data)}
    elif isinstance(data, str):
        r = {"type": "url", "url": data}
    return {"type": "document", "source": r}
```

</details>

Letâ€™s test our changes on a financial report.

``` python
pdf = Path('financial_report.pdf').read_bytes()
msg = mk_msg([pdf, "what was the average monthly revenue for product D?"], api="anthropic")
_, text = anthropic_chat([msg])
text
```

    'Looking at the Product D chart on page 5, I can see the monthly revenue values for each month of 2023. Let me calculate the average:\n\nFrom the chart, the approximate monthly revenues for Product D are:\n- January: $900\n- February: $500\n- March: $400\n- April: $700\n- May: $800\n- June: $900\n- July: $1000\n- August: $1050\n- September: $1200\n- October: $1300\n- November: $1300\n- December: $1300\n\nTotal revenue: $11,350\nNumber of months: 12\n\nAverage monthly revenue for Product D = $11,350 Ã· 12 = **$945.83**'

``` python
pdf_url = "https://arxiv.org/pdf/2506.18880"
msg = mk_msg([pdf_url, "What were the three types of generalization the authors of this paper looked at?"], api="anthropic")
_, text = anthropic_chat([msg])
text
```

    'Based on the paper, the authors examined three types of generalization, inspired by Boden\'s typology of creativity:\n\n1. **Exploratory Generalization** - Assessing whether models can apply known problem-solving skills to more complex instances within the same problem domain. For example, counting rectangles in an octagon (training) versus a dodecagon (test). This tests if models can faithfully extend a single reasoning strategy beyond the complexity range seen during training.\n\n2. **Compositional Generalization** - Evaluating the ability to combine distinct reasoning skills, previously learned in isolation, to solve novel problems that require integrating these skills in new and coherent ways. For example, combining GCD computation with polynomial root-finding to solve problems that require both skills working together synergistically.\n\n3. **Transformative Generalization** - Testing whether models can adopt novel, often unconventional strategies by moving beyond familiar approaches to solve problems more effectively. This involves abandoning a familiar but ineffective strategy in favor of a qualitatively different and more efficient approach - essentially requiring a "jump out of the box" or creative reframing. For instance, replacing brute-force enumeration with a subtractive counting method that overcounts and then removes invalid cases.\n\nThe authors designed OMEGA to systematically evaluate these three axes of out-of-distribution generalization using carefully constructed training-test pairs that isolate each specific reasoning capability.'

### Conversation

LLMs are stateless. To continue a conversation we need to include the
entire message history in every API call. By default the role in each
message alternates between `user` and `assistant`.

Letâ€™s add a method that alternates the roles for us and then calls
[`mk_msgs`](https://AnswerDotAI.github.io/msglm/core.html#mk_msgs).

``` python
def mk_msgs(msgs: list, *args, api:str="openai", **kw) -> list:
    "Create a list of messages compatible with OpenAI/Anthropic."
    if isinstance(msgs, str): msgs = [msgs]
    return [mk_msg(o, ('user', 'assistant')[i % 2], *args, api=api, **kw) for i, o in enumerate(msgs)]
```

``` python
mk_msgs(["Hello", "Some assistant response", "tell me a joke"])
```

    [{'role': 'user', 'content': 'Hello'},
     {'role': 'assistant', 'content': 'Some assistant response'},
     {'role': 'user', 'content': 'tell me a joke'}]

### SDK Objects

To make our lives even easier, it would be nice if
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) could
format the SDK objects returned from a previous chat so that we can pass
them straight to
[`mk_msgs`](https://AnswerDotAI.github.io/msglm/core.html#mk_msgs).

The OpenAI SDK accepts objects like `ChatCompletion` as messages.
Anthropic is different and expects every message to have the `role`,
`content` format that weâ€™ve seen so far.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L112"
target="_blank" style="float:right; font-size:smaller">source</a>

### Msg.\_\_call\_\_

``` python

def __call__(
    role:str, content:[<class 'list'>, <class 'str'>], text_only:bool=False, kw:VAR_KEYWORD
)->dict:

```

*Create an OpenAI/Anthropic compatible message with `role` and
`content`.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L132"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg.find_block

``` python

def find_block(
    r
):

```

*Find the message in `r`.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L127"
target="_blank" style="float:right; font-size:smaller">source</a>

### AnthropicMsg.is_sdk_obj

``` python

def is_sdk_obj(
    r
)->bool:

```

*Check if `r` is an SDK object.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L144"
target="_blank" style="float:right; font-size:smaller">source</a>

### OpenAiMsg.find_block

``` python

def find_block(
    r
):

```

*Find the message in `r`.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L138"
target="_blank" style="float:right; font-size:smaller">source</a>

### OpenAiMsg.is_sdk_obj

``` python

def is_sdk_obj(
    r
)->bool:

```

*Check if `r` is an SDK object.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L151"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_msgs

``` python

def mk_msgs(
    msgs:list, args:VAR_POSITIONAL, api:str='openai', kw:VAR_KEYWORD
)->list:

```

*Create a list of messages compatible with OpenAI/Anthropic.*

Letâ€™s test our changes.

``` python
msgs = ["tell me a joke"]
r, text = openai_chat(mk_msgs(msgs))
text
```

    'Why did the AI go to art school?  \nTo learn how to draw better conclusions!'

``` python
msgs += [r, "tell me another joke that's similar to your first joke"]
mm = mk_msgs(msgs)
mm
```

    [{'role': 'user', 'content': 'tell me a joke'},
     ResponseReasoningItem(id='rs_689f894eb37c81a195cd499fd5276b2a08571b67e9050be5', summary=[], type='reasoning', content=None, encrypted_content=None, status=None),
     ResponseOutputMessage(id='msg_689f8951d0b881a1b8f69315efed0efa08571b67e9050be5', content=[ResponseOutputText(annotations=[], text='Why did the AI go to art school?  \nTo learn how to draw better conclusions!', type='output_text', logprobs=[])], role='assistant', status='completed', type='message'),
     {'role': 'user',
      'content': "tell me another joke that's similar to your first joke"}]

``` python
r, text = openai_chat(mm)
text
```

    'Why did the AI enroll in a sculpting class?  \nTo improve its model-shaping skills!'

### Usage

To make `msglm` a little easier to use letâ€™s create OpenAI and Anthropic
wrappers for
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) and
[`mk_msgs`](https://AnswerDotAI.github.io/msglm/core.html#mk_msgs).

``` python
mk_msg_anthropic = partial(mk_msg, api="anthropic")
mk_msgs_anthropic = partial(mk_msgs, api="anthropic")
```

If youâ€™re using OpenAI you should be able to use the import below

``` python
from msglm import mk_msg_openai as mk_msg, mk_msgs_openai as mk_msgs
```

Similarily for Anthropic

``` python
from msglm import mk_msg_anthropic as mk_msg, mk_msgs_anthropic as mk_msgs
```

## Extra features

### Caching

Anthropic currently offers [prompt
caching](https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching),
which can reduce cost and latency.

To cache a message, we simply add a `cache_control` field to our content
as shown below.

``` js
{
    "role": "user",
    "content": [
        {
            "type": "text",
            "text": "Hello, can you tell me more about the solar system?",
            "cache_control": {"type": "ephemeral"}
        }
    ]
}
```

Letâ€™s update our
[`mk_msg`](https://AnswerDotAI.github.io/msglm/core.html#mk_msg) and
[`mk_msgs`](https://AnswerDotAI.github.io/msglm/core.html#mk_msgs)
Anthropic wrappers to support caching.

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L190"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_msgs_anthropic

``` python

def mk_msgs_anthropic(
    args:VAR_POSITIONAL, cache:bool=False, ttl:NoneType=None, cache_last_ckpt_only:bool=False, api:str='openai'
):

```

*Create a list of Anthropic compatible messages.*

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L184"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_msg_anthropic

``` python

def mk_msg_anthropic(
    args:VAR_POSITIONAL, cache:bool=False, ttl:NoneType=None, role:str='user', api:str='openai'
):

```

*Create an Anthropic compatible message.*

Letâ€™s see caching in action

``` python
mk_msg_anthropic("Don't cache my message")
```

``` json
{'content': "Don't cache my message", 'role': 'user'}
```

``` python
mk_msg_anthropic("Please cache my message", cache=True)
```

``` json
{ 'content': [ { 'cache_control': {'type': 'ephemeral'},
                 'text': 'Please cache my message',
                 'type': 'text'}],
  'role': 'user'}
```

``` python
mk_msg_anthropic("Cache for 1 hour", cache=True, ttl="1h")
```

``` json
{ 'content': [ { 'cache_control': {'ttl': '1h', 'type': 'ephemeral'},
                 'text': 'Cache for 1 hour',
                 'type': 'text'}],
  'role': 'user'}
```

### Citations

The Anthropic API provides detailed
[citations](https://docs.anthropic.com/en/docs/build-with-claude/citations)
when answering questions about documents.

When citations are enabled a citations block like the one below will be
included in the response.

``` js
{
  "content": [
    { "type": "text", "text": "According to the document, " },
    {
      "type": "text", "text": "the grass is green",
      "citations": [{
        "type": "char_location",
        "cited_text": "The grass is green.",
        "document_index": 0, "document_title": "Example Document",
        "start_char_index": 0, "end_char_index": 20
      }]
    }
  ]
}
```

To enable citations you need to create an Anthropic document with the
following structure.

``` js
{
    "type": "document",
    "source": {...},
    "title": "Document Title", # optional
    "context": "Context about the document that will not be cited from", # optional
    "citations": {"enabled": True}
}
```

Currently Anthropic supports citations on 3 document types: - text -
pdfs - custom

A **text** document has the following source structure.

``` js
{"type": "text", "media_type": "text/plain", "data": "Plain text content..."}
```

Hereâ€™s the source structure for a **pdf**.

``` js
{"type": "base64", "media_type": "application/pdf", "data": b64_enc_data}
```

Finally, hereâ€™s the source structure for a **custom** document.

``` js
{
  "type": "content",
  "content": [
    {"type": "text", "text": "First chunk"},
    {"type": "text", "text": "Second chunk"}
  ]
}
```

------------------------------------------------------------------------

<a
href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L199"
target="_blank" style="float:right; font-size:smaller">source</a>

### mk_ant_doc

``` python

def mk_ant_doc(
    content, title:NoneType=None, context:NoneType=None, citation:bool=True, kws:VAR_KEYWORD
):

```

*Create an Anthropic document.*

Hereâ€™s how you would implement the example from the citationâ€™s
[docs](https://docs.anthropic.com/en/docs/build-with-claude/citations).

``` python
doc = mk_ant_doc("The grass is green. The sky is blue.", title="My Document", context="This is a trustworthy document.")
mk_msg([doc, "What color is the grass and sky?"])
```

``` json
{ 'content': [ { 'citations': {'enabled': True},
                 'context': 'This is a trustworthy document.',
                 'source': { 'data': 'The grass is green. The sky is blue.',
                             'media_type': 'text/plain',
                             'type': 'text'},
                 'title': 'My Document',
                 'type': 'document'},
               { 'text': 'What color is the grass and sky?',
                 'type': 'input_text'}],
  'role': 'user'}
```
